<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YALLA RIDE | Advanced Chat</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #00d2ff; --dark: #0b0e11; --card: #15191d;
            --nav: #1a1f24; --gold: #ffcf33; --danger: #ff4d4d;
            --text: #ffffff; --chat-bg: #1e252b; --own-msg: #00d2ff;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Cairo', sans-serif; }
        body { background-color: var(--dark); color: var(--text); overflow-x: hidden; }

        nav {
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 5%; background: var(--nav); height: 80px;
            position: sticky; top: 0; z-index: 1000; border-bottom: 1px solid #333;
        }
        .logo-container { display: flex; align-items: center; gap: 12px; cursor: pointer; }
        .main-logo { height: 50px; width: 50px; object-fit: contain; }
        
        .nav-links { display: flex; gap: 20px; list-style: none; align-items: center; }
        .nav-links li a { color: #aaa; text-decoration: none; font-size: 1.2rem; cursor: pointer; transition: 0.3s; }
        .nav-links li a:hover, .nav-links li a.active { color: var(--primary); }

        .page { display: none; padding: 20px 5%; animation: slideUp 0.4s ease; }
        .page.active { display: block; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

        .container { max-width: 600px; margin: auto; }
        
        /* Advanced Chat Styling */
        #chat-window {
            height: 55vh; background: var(--chat-bg); border-radius: 20px 20px 0 0;
            overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px;
            border: 1px solid #333; border-bottom: none; scroll-behavior: smooth;
        }
        
        .reply-preview {
            background: #2a333c; padding: 10px; border-right: 4px solid var(--primary);
            display: none; justify-content: space-between; align-items: center; font-size: 0.8rem;
        }

        .chat-input-area {
            display: flex; flex-direction: column; background: var(--nav); 
            border-radius: 0 0 20px 20px; border: 1px solid #333; padding: 10px;
        }
        .input-row { display: flex; gap: 10px; padding: 5px; }
        
        .emoji-bar { display: flex; gap: 10px; padding: 5px 15px; border-top: 1px solid #222; overflow-x: auto; }
        .emoji-item { cursor: pointer; font-size: 1.2rem; transition: 0.2s; }
        .emoji-item:hover { transform: scale(1.3); }

        .message { display: flex; gap: 10px; max-width: 85%; position: relative; }
        .msg-own { align-self: flex-end; flex-direction: row-reverse; }
        .msg-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary); }
        
        .msg-content { 
            background: #2a333c; padding: 12px 18px; border-radius: 18px; 
            font-size: 0.95rem; position: relative; cursor: pointer;
        }
        .msg-own .msg-content { background: var(--own-msg); color: #000; font-weight: bold; }
        .msg-admin .msg-content { border: 1px solid var(--gold); box-shadow: 0 0 10px rgba(255,207,51,0.2); }
        
        .msg-reply-box { 
            background: rgba(0,0,0,0.2); padding: 5px 10px; border-radius: 10px; 
            font-size: 0.75rem; border-right: 3px solid #666; margin-bottom: 8px; opacity: 0.8;
        }

        .del-msg { color: var(--danger); font-size: 0.8rem; cursor: pointer; display: block; margin-top: 5px; }

        /* General UI */
        button { background: var(--primary); color: #000; font-weight: 900; cursor: pointer; padding: 12px; border-radius: 12px; border: none; }
        input { width: 100%; padding: 12px; border-radius: 12px; border: 1px solid #333; background: #222; color: white; outline: none; }
        .hidden { display: none !important; }
        #toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); background: var(--primary); color: #000; padding: 10px 25px; border-radius: 50px; display: none; z-index: 9999; }
    </style>
</head>
<body>

<nav>
    <div class="logo-container" onclick="showPage('home')">
        <img src="IMG_0660.PNG" alt="Logo" class="main-logo" onerror="this.src='https://via.placeholder.com/50'">
        <span style="font-weight:900; color:var(--primary)">YALLA RIDE</span>
    </div>
    <ul class="nav-links">
        <li><a onclick="showPage('home')"><i class="fa-solid fa-house"></i></a></li>
        <li><a onclick="showPage('chat')"><i class="fa-solid fa-comments"></i></a></li>
        <li><a onclick="showPage('leaderboard')"><i class="fa-solid fa-ranking-star"></i></a></li>
        <li id="nav-admin" class="hidden"><a onclick="showPage('admin')"><i class="fa-solid fa-user-gear"></i></a></li>
        <li id="nav-profile" class="hidden"><a onclick="showPage('profile')"><i class="fa-solid fa-circle-user"></i></a></li>
        <li id="nav-login"><a onclick="showPage('login')"><i class="fa-solid fa-right-to-bracket"></i></a></li>
    </ul>
</nav>

<div id="chat" class="page">
    <div class="container">
        <h3 style="margin-bottom: 15px; text-align: center;"><i class="fa-solid fa-users"></i> Ù…Ù„ØªÙ‚Ù‰ Ø§Ù„Ø£Ø¨Ø·Ø§Ù„</h3>
        
        <div id="chat-window"></div>

        <div class="chat-input-area">
            <div id="reply-preview" class="reply-preview">
                <span id="reply-text">Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰: ...</span>
                <i class="fa-solid fa-xmark" onclick="cancelReply()" style="cursor:pointer;"></i>
            </div>
            
            <div class="input-row">
                <input type="text" id="chat-msg-input" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ...">
                <button onclick="sendChatMessage()" style="width: 60px;"><i class="fa-solid fa-paper-plane"></i></button>
            </div>

            <div class="emoji-bar">
                <span class="emoji-item" onclick="addEmoji('ğŸš´â€â™‚ï¸')">ğŸš´â€â™‚ï¸</span>
                <span class="emoji-item" onclick="addEmoji('ğŸ”¥')">ğŸ”¥</span>
                <span class="emoji-item" onclick="addEmoji('ğŸ‘')">ğŸ‘</span>
                <span class="emoji-item" onclick="addEmoji('ğŸ’ª')">ğŸ’ª</span>
                <span class="emoji-item" onclick="addEmoji('ğŸ')">ğŸ</span>
                <span class="emoji-item" onclick="addEmoji('â¤ï¸')">â¤ï¸</span>
                <span class="emoji-item" onclick="addEmoji('ğŸ˜‚')">ğŸ˜‚</span>
            </div>
        </div>
        <p style="text-align: center; color: #555; font-size: 0.7rem; margin-top: 10px;">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø£ÙŠ Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ø±Ø¯ Ø¹Ù„ÙŠÙ‡Ø§</p>
    </div>
</div>

<div id="home" class="page active" style="text-align:center;">
    <div style="margin-top: 20vh;">
        <img src="IMG_0660.PNG" style="width: 130px; margin-bottom: 20px;">
        <h1 style="font-size: 3rem;">YALLA RIDE</h1>
        <button onclick="showPage('chat')" style="margin-top:30px; width:220px;">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø¢Ù†</button>
    </div>
</div>

<div id="leaderboard" class="page">
    <div class="container" id="l-list" style="background:var(--card); padding:20px; border-radius:20px;"></div>
</div>

<div id="profile" class="page">
    <div class="container" style="text-align:center; background:var(--card); padding:30px; border-radius:20px;">
        <img id="user-pic" src="" style="width:120px; height:120px; border-radius:50%; border:3px solid var(--primary); object-fit: cover;">
        <h2 id="display-name" style="margin:15px 0;"></h2>
        <button onclick="logout()" style="background:var(--danger); color:white;">Ø®Ø±ÙˆØ¬</button>
    </div>
</div>

<div id="login" class="page">
    <div class="container card" style="background:var(--card); padding:30px; border-radius:20px;">
        <h2 id="auth-title">Ø¯Ø®ÙˆÙ„</h2>
        <input type="text" id="reg-name" class="hidden" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„">
        <input type="email" id="auth-email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
        <input type="password" id="auth-pass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
        <button onclick="handleAuth()">Ø¯Ø®ÙˆÙ„</button>
        <p onclick="toggleAuth()" style="cursor:pointer; text-align:center; margin-top:15px; color:var(--primary);">ØªØ¨Ø¯ÙŠÙ„ ØªØ³Ø¬ÙŠÙ„/Ø¯Ø®ÙˆÙ„</p>
    </div>
</div>

<div id="toast"></div>

<script>
    let users = JSON.parse(localStorage.getItem('yalla_final_db')) || [];
    let messages = JSON.parse(localStorage.getItem('yalla_chat_v2')) || [];
    let currentUser = JSON.parse(sessionStorage.getItem('yalla_session')) || null;
    let replyToId = null;

    function showPage(id) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if(id === 'chat') { renderChat(); scrollChat(); }
        if(id === 'leaderboard') renderLeaderboard();
        if(id === 'profile') {
            document.getElementById('display-name').innerText = currentUser.name;
            document.getElementById('user-pic').src = currentUser.pic || 'https://via.placeholder.com/120';
        }
    }

    // --- Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ù…Ø·ÙˆØ± ---
    function addEmoji(emoji) {
        document.getElementById('chat-msg-input').value += emoji;
    }

    function setReply(id, text, name) {
        replyToId = id;
        document.getElementById('reply-preview').style.display = 'flex';
        document.getElementById('reply-text').innerText = `Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ ${name}: ${text.substring(0, 20)}...`;
    }

    function cancelReply() {
        replyToId = null;
        document.getElementById('reply-preview').style.display = 'none';
    }

    function sendChatMessage() {
        if(!currentUser) return notify("Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„Ùƒ Ø£ÙˆÙ„Ø§Ù‹");
        const input = document.getElementById('chat-msg-input');
        if(!input.value.trim()) return;

        const newMsg = {
            id: Date.now(),
            senderEmail: currentUser.email,
            senderName: currentUser.name,
            senderPic: currentUser.pic || '',
            text: input.value,
            isAdmin: currentUser.email === "dev@yallaride.com",
            replyTo: replyToId ? messages.find(m => m.id === replyToId) : null,
            time: new Date().toLocaleTimeString('ar-SA', {hour:'2-digit', minute:'2-digit'})
        };

        messages.push(newMsg);
        localStorage.setItem('yalla_chat_v2', JSON.stringify(messages));
        input.value = '';
        cancelReply();
        renderChat();
        scrollChat();
    }

    function renderChat() {
        const win = document.getElementById('chat-window');
        win.innerHTML = messages.map(m => {
            const isOwn = currentUser && m.senderEmail === currentUser.email;
            return `
                <div class="message ${isOwn ? 'msg-own' : ''} ${m.isAdmin ? 'msg-admin' : ''}">
                    <img src="${m.senderPic || 'https://via.placeholder.com/40'}" class="msg-avatar">
                    <div class="msg-content" onclick="setReply(${m.id}, '${m.text}', '${m.senderName}')">
                        <span style="font-size:0.7rem; color:${m.isAdmin ? 'var(--gold)' : '#888'}; font-weight:bold;">
                            ${m.isAdmin ? 'â˜… Ø§Ù„Ù…Ø·ÙˆØ±' : m.senderName}
                        </span>
                        ${m.replyTo ? `<div class="msg-reply-box"><b>${m.replyTo.senderName}:</b> ${m.replyTo.text}</div>` : ''}
                        <div>${m.text}</div>
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-top:5px;">
                            <small style="font-size:0.6rem; opacity:0.5;">${m.time}</small>
                            ${(currentUser && currentUser.email === "dev@yallaride.com") ? `<i class="fa-solid fa-trash del-msg" onclick="deleteMessage(${m.id}); event.stopPropagation();"></i>` : ''}
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }

    function deleteMessage(id) {
        messages = messages.filter(m => m.id !== id);
        localStorage.setItem('yalla_chat_v2', JSON.stringify(messages));
        renderChat();
    }

    function scrollChat() {
        const win = document.getElementById('chat-window');
        win.scrollTop = win.scrollHeight;
    }

    // --- Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ---
    function handleAuth() {
        const e = document.getElementById('auth-email').value;
        const p = document.getElementById('auth-pass').value;
        const n = document.getElementById('reg-name').value;
        const isReg = !document.getElementById('reg-name').classList.contains('hidden');

        if(e === "dev@yallaride.com" && p === "Dev2026") {
            currentUser = { name: "Ø§Ù„Ù…Ø·ÙˆØ±", email: e, isAdmin: true };
        } else if(isReg) {
            const newUser = { name: n, email: e, pass: p, km: 0, pic: '' };
            users.push(newUser);
            localStorage.setItem('yalla_final_db', JSON.stringify(users));
            currentUser = newUser;
        } else {
            const u = users.find(x => x.email === e && x.pass === p);
            if(u) currentUser = u; else return notify("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
        }
        sessionStorage.setItem('yalla_session', JSON.stringify(currentUser));
        updateNav(); showPage('home');
    }

    function renderLeaderboard() {
        document.getElementById('l-list').innerHTML = `<h3 style="text-align:center; color:var(--gold);">ğŸ† Ù„ÙˆØ­Ø© Ø§Ù„Ø´Ø±Ù</h3>` + users.sort((a,b)=>b.km-a.km).map((u,i) => `
            <div style="display:flex; justify-content:space-between; padding:12px; border-bottom:1px solid #222; align-items:center;">
                <div style="display:flex; align-items:center; gap:10px;">
                    <span style="color:#666; width:20px;">${i+1}</span>
                    <img src="${u.pic || 'https://via.placeholder.com/40'}" style="width:35px; height:35px; border-radius:50%; object-fit:cover;">
                    <b>${u.name}</b>
                </div>
                <span style="color:var(--primary);">${u.km} ÙƒÙ…</span>
            </div>`).join('');
    }

    function toggleAuth() { document.getElementById('reg-name').classList.toggle('hidden'); }
    function updateNav() {
        document.getElementById('nav-profile').classList.toggle('hidden', !currentUser);
        document.getElementById('nav-login').classList.toggle('hidden', !!currentUser);
        document.getElementById('nav-admin').classList.toggle('hidden', !currentUser || currentUser.email !== "dev@yallaride.com");
    }
    function logout() { currentUser = null; sessionStorage.clear(); updateNav(); showPage('home'); }
    function notify(m) { const t = document.getElementById('toast'); t.innerText = m; t.style.display = 'block'; setTimeout(()=>t.style.display='none', 2000); }

    updateNav();
</script>
</body>
</html>
